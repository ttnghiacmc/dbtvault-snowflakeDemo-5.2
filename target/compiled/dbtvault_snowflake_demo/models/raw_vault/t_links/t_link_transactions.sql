-- Generated by dbtvault.

WITH stage AS (
    SELECT "TRANSACTION_PK", "CUSTOMER_PK", "ORDER_PK", "TRANSACTION_NUMBER", "TRANSACTION_DATE", "TYPE", "AMOUNT", "EFFECTIVE_FROM", "LOAD_DATE", "RECORD_SOURCE"
    FROM DV_PROTOTYPE_DB.dbt_ttnghiacmc.v_stg_transactions
    WHERE "TRANSACTION_PK" IS NOT NULL
    AND "CUSTOMER_PK" IS NOT NULL
    AND "ORDER_PK" IS NOT NULL
),
records_to_insert AS (
    SELECT DISTINCT stg."TRANSACTION_PK", stg."CUSTOMER_PK", stg."ORDER_PK", stg."TRANSACTION_NUMBER", stg."TRANSACTION_DATE", stg."TYPE", stg."AMOUNT", stg."EFFECTIVE_FROM", stg."LOAD_DATE", stg."RECORD_SOURCE"
    FROM stage AS stg
    LEFT JOIN DV_PROTOTYPE_DB.dbt_ttnghiacmc.t_link_transactions AS tgt
    ON stg."TRANSACTION_PK" = tgt."TRANSACTION_PK"
    WHERE tgt."TRANSACTION_PK" IS NULL
)

SELECT * FROM records_to_insert